{% extends 'base.html' %}
{% load staticfiles %}
{% load custom_tags %}

{% comment %}

   Copyright 2016, Institute for Systems Biology

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

{% endcomment %}

{% block header %}
{% endblock %}
{% block link_page_name %}cohort-details{% endblock %}
{% block page_name %}cohort-details{% endblock %}

{% block page_header %}
<link type="text/css" rel="stylesheet" href="{% static 'css/token-typeahead.css' %}" />

<div class="container">
    {% if workbook %}
        <ol class="breadcrumb">
            <li><a href="{% url 'dashboard' %}">Your Dashboard</a></li>
            <li><a href="{% url 'workbooks' %}">Saved Workbooks</a></li>
            <li><a href="{% url 'worksheet_display' workbook.id worksheet.id%}">{{ workbook.name }}</a></li>
        </ol>
    {% else %}
        <ol class="breadcrumb">
            <li><a href="{% url 'dashboard' %}">Your Dashboard</a></li>
            <li><a href="{% url 'cohort_list' %}">Cohorts</a></li>
        </ol>
    {% endif %}
    <h1 class="page-header pull-left">Create Cohort</h1>
    {% if workbook %}
        <button class="btn btn-primary pull-right" data-toggle="modal" data-target="#create-cohort-modal">Apply to Worksheet</button>
    {% elif create_workbook %}
        <button class="btn btn-primary pull-right" data-toggle="modal" data-target="#create-cohort-modal">Apply to new Worksheet</button>
    {% else %}
        <button class="btn btn-primary pull-right" data-toggle="modal" data-target="#create-cohort-modal">Save As New Cohort</button>
    {% endif %}
</div>

{% endblock %}

{% block content %}

    <div id="url-len-max-alert" class="alert alert-warning alert-dismissable col-lg-12" style="display: none;">
        <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        You have selected too many filters. The current counts shown will not be accurate until one or more filter options are removed.
    </div>

    <div id="filter-panel" class="col-lg-4" role="tabpanel">
        <div class="tabpanel" role="tabpanel">
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#clinical-filters" role="tab" data-toggle="tab" title="Donor Filters">Donor</a></li>
                <li role="presentation" class=""><a href="#data-filters" role="tab" data-toggle="tab" title="Donor Filters">Data Type</a></li>
                <li role="presentation" class=""><a href="#molecular-filters" role="tab" data-toggle="tab" title="Molecular Filters">Molecular</a></li>
                <li role="presentation" class=""><a href="#user-data-filters" role="tab" data-toggle="tab" title="User Data">User Data</a></li>
            </ul>
            <div class="tab-content">
                <!-- donor filters tab -->
                <div role="tabpanel" class="tab-pane active" id="clinical-filters">
                    <ul class="list-group" id="clin-accordion" role="tablist" aria-multiselectable="true">
                        {% for attr in clin_attr %}
                            {% if attr_list_count|list_contains_name:attr %}
                                <li class="list-group-item">
                                    <div id="heading-{{attr}}" class="list-group-item__heading">
                                        <a role="button" data-toggle="collapse" data-parent="#clin-accordion" href="#collapse-{{ attr }}" aria-expanded="false" aria-controls="collapse-{{ attr }}">
                                            <i class="fa fa-caret-right"></i><i class="fa fa-caret-down"></i> {{ attr|get_readable_name }}
                                        </a>
                                    </div>

                                    <div id="collapse-{{ attr }}" class="list-group-item__body collapse cohort-feature-select-block" role="tabpanel" data-feature-type="donor"
                                         aria-labelledby="heading-{{ attr }}" data-feature-name="{{ attr }}" data-feature-displ-name="{{ attr|get_feat_displ_name }}"
                                         data-feature-id="{% if attr_list_count|get_named_item:attr|get_item:'id' %}{{ attr_list_count|get_named_item:attr|get_item:'id' }}{% endif %}">
                                        <ul class="search-checkbox-list" id="{{ attr }}">
                                            {% with attr_list_count|get_named_item:attr|get_item:'values'|how_many_more:6 as num_more %}
                                                {% for v in attr_list_count|get_named_item:attr|get_item:'values'|check_for_order:attr %}
                                                    {% if forloop.counter0 < 6 %}
                                                        <li class="checkbox">
                                                            <label title="{{ v.value|get_tooltip_text:attr }}">
                                                                <input type="checkbox" name="elements-selected" data-value-name="{{ v.value }}"
                                                                       data-value-displ-name="{% if v.displ_name %}{{ v.displ_name }}{% endif %}"
                                                                       data-value-id="{% if v.id %}{{ v.id }}{% elif v.name %}{{ v.name }}{% else %}{{ v.value }}{% endif %}">
                                                                {% if v.value == 'None' %}NA{% elif v.displ_name %}{{ v.displ_name|get_readable_name:attr }}{% else %}{{ v.value|get_readable_name:attr }}{% endif %}
                                                                 <span class="count">({{ v.count }})</span>
                                                            </label>
                                                        </li>
                                                    {% elif forloop.counter0 == 6 and num_more > 0 %}
                                                        <p class="more-checks"><a class="show-more">{{ num_more }} more</a><span class="checks"><a class="check-all">Check All</a> / <a class="uncheck-all">Uncheck All</a></span></p>
                                                        <li class="extra-values checkbox" style="display:none;">
                                                            <label title="{{ v.value|get_tooltip_text:attr }}">
                                                                <input type="checkbox" name="elements-selected" data-value-name="{{ v.value }}"
                                                                       data-value-displ-name="{% if v.displ_name %}{{ v.displ_name }}{% endif %}"
                                                                       data-value-id="{% if v.id %}{{ v.id }}{% elif v.name %}{{ v.name }}{% else %}{{ v.value }}{% endif %}">
                                                                {% if v.value == 'None' %}NA{% elif v.displ_name %}{{ v.displ_name|get_readable_name:attr }}{% else %}{{ v.value|get_readable_name:attr }}{% endif %}
                                                                 <span class="count">({{ v.count }})</span>
                                                            </label>
                                                        </li>
                                                    {% else %}
                                                        <li class="extra-values checkbox" style="display:none;">
                                                            <label title="{{ v.value|get_tooltip_text:attr }}">
                                                                <input type="checkbox" name="elements-selected" data-value-name="{{ v.value }}"
                                                                       data-value-displ-name="{% if v.displ_name %}{{ v.displ_name }}{% endif %}"
                                                                       data-value-id="{% if v.id %}{{ v.id }}{% elif v.name %}{{ v.name }}{% else %}{{ v.value }}{% endif %}">
                                                                {% if v.value == 'None' %}NA{% elif v.displ_name %}{{ v.displ_name|get_readable_name:attr }}{% else %}{{ v.value|get_readable_name:attr }}{% endif %}
                                                                 <span class="count">({{ v.count }})</span>
                                                            </label>
                                                        </li>
                                                    {% endif %}
                                                {% endfor %}
                                                {% if num_more > 0 %}
                                                    <p class="less-checks" style="display: none;"><a class="show-less">less</a><span class="checks"><a class="check-all">Check All</a> / <a class="uncheck-all">Uncheck All</a></span></p>
                                                {% endif %}
                                            {% endwith %}
                                        </ul>
                                    </div>
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                <!-- data filters tab -->
                <div role="tabpanel" class="tab-pane" id="data-filters">
                    <ul class="list-group" id="data-type-accordion" role="tablist" aria-multiselectable="true">
                        {% for attr in data_attr %}
                            <li class="list-group-item">
                                <div class="list-group-item__heading" role="tab" id="heading-{{ attr }}">
                                    <a role="button" data-toggle="collapse" data-parent="#data-type-accordion" href="#collapse-{{ attr }}"
                                       aria-expanded="false" aria-controls="collapse-{{ attr }}" {% if attr == 'miRNA_sequencing' %}style="text-transform:none!important"{% endif %}>
                                        <i class="fa fa-caret-right"></i><i class="fa fa-caret-down" style="display:none;"></i> {{ attr|get_readable_name }}
                                    </a>
                                </div>
                                <div id="collapse-{{ attr }}" class="list-group-item__body collapse cohort-feature-select-block" role="tabpanel"
                                     aria-labelledby="heading-{{ attr }}" data-feature-name="{{ attr }}" data-feature-displ-name="{{ attr|get_feat_displ_name }}" data-feature-type="datatype">
                                    <ul class="search-checkbox-list" id="{{ attr }}">
                                        {% if attr_list_count|list_contains_name:attr %}
                                            {% for v in attr_list_count|get_named_item:attr|get_item:'values' %}
                                                <li class="checkbox">
                                                    <!-- todo: make a custom tag for the id for data_attr attributes-->
                                                    <label>
                                                        <input type="checkbox" name="elements-selected" data-value-name="{{ v.value|get_data_attr_id:attr }}"
                                                               data-value-displ-name="{% if v.value == 'None' %}NA{% elif v.displ_name %}{{ v.displ_name }}{% else %}{{ v.value }}{% endif %}">
                                                         {% if v.value == 'None' %}NA{% else %}{{ v.value }}{% endif %} <span class="count">({{ v.count }})</span>
                                                    </label>
                                                </li>
                                            {% endfor %}
                                        {% endif %}
                                    </ul>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                <!-- molecular filters tab -->
                <div role="tabpanel" class="tab-pane" id="molecular-filters">
                    <ul class="list-group" id="molecular-accordion" role="tablist" aria-multiselectable="true">
                        <li class="list-group-item">
                            <div id="molecular-filter-alert" class="alert alert-warning alert-dismissable" style="display: none;">
                                <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                A large amount of data must be processed to use these filters, which can result in some delays.
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="list-group-item__heading" role="tab" id="heading-gene-mutation-status">
                                <a role="button" data-toggle="collapse" data-parent="#data-type-accordion" href="#collapse-gene-mutation-status" aria-expanded="false" aria-controls="collapse-gene-mutation-status">
                                    <i class="fa fa-caret-right"></i><i class="fa fa-caret-down" style="display:none;"></i> GENE MUTATION STATUS
                                </a>
                            </div>
                            <div id="collapse-gene-mutation-status" class="list-group-item__body collapse cohort-feature-select-block" role="tabpanel"
                                 aria-labelledby="heading-gene-mutation-status" data-feature-name="gene-mutation-status" data-feature-displ-name="Gene Mutation Status" data-feature-type="molecular">
                                <ul class="list">
                                    <li class="list-item">
                                        <!-- gene selector -->
                                        <div class="list-item__heading" role="tab" id="heading-sel-gene">
                                                Gene
                                        </div>
                                        <div id="sel-gene" class="list-group-item__body" role="tabpanel" aria-labelledby="heading-sel-gene">
                                            <div id="tokenfield-holder">
                                                <textarea name="genes-list" class="form-control tokenfield" id="paste-in-genes" placeholder="Enter a gene's name" required></textarea>
                                            </div>
                                            <div class="tokenfield">
                                                <p class="helper-text__invalid" style="display: none;"><i class="fa fa-exclamation-circle"></i> The following <span class="token invalid">items</span>were not recognized as gene identifiers. You may either correct or delete these items -- or use them as-is.</p>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="list-item">
                                        <!-- Mutation Category Selector -->
                                        <div class="list-item__heading" role="tab" id="heading-sel-molecular-attr-cat">
                                                Mutation Type Categories
                                        </div>
                                        <div id="sel-molecular-attr-cat" class="list-group-item__body cohort-feature-select-block" role="tabpanel"
                                             aria-labelledby="heading-sel-molecular-attr-cat" data-feature-displ-name="Mutation Category" data-feature-id="category"
                                             data-feature-name="mutation-category" data-feature-type="molecular">
                                            <select id="mutation-category" class="mutation-category-selector form-control spec-select datatype-selector">
                                                <option value="no-gene" selected disabled>-- Select a Gene to Enable Categories --</option>
                                                <option value="label" disabled>-- Select a Mutation Category --</option>
                                                <option value="any" data-value-displ-name="Any" data-value-name="Any" data-value-id="any">Any</option>
                                                {% for cat in molecular_attr.categories %}
                                                    <option value="{{ cat.value }}" data-value-displ-name="{{ cat.name }}" data-value-name="{{ cat.name }}"
                                                            data-value-id="{% if cat.id %}{{ cat.id }}{% else %}{{ cat.value }}{% endif %}">{{ cat.name }}</option>
                                                {% endfor %}
                                                <option value="indv-selex">Individual Selection</option>
                                            </select>
                                        </div>
                                    </li>
                                    <li class="list-item">
                                        <!-- Specific Mutation Type Checkboxes -->
                                        <div class="list-item__heading" role="tab" id="heading-spec-molecular-attrs">
                                            <span title="Choose the 'Individual Selection' category to enable this section">Individual Mutation Types</span>
                                        </div>
                                        <span class="heading-note" id="spec-mol-attr-heading-note">Choose the 'Individual Selection' category to enable</span>
                                        <div id="spec-molecular-attrs" class="list-group-item__body cohort-feature-select-block" role="tabpanel"
                                             aria-labelledby="heading-spec-molecular-attrs" data-feature-displ-name="Specific Mutation Type" data-feature-name="specific-mutation"
                                             data-feature-id="specific" data-feature-type="molecular">
                                            <ul class="search-checkbox-list" id="{{ attr.value }}">
                                                {% for attr in molecular_attr.attrs %}
                                                    <li class="checkbox">
                                                        <label>
                                                            <input class="mutation-checkbox" type="checkbox" name="elements-selected" data-value-name="{{ attr.value }}"
                                                                   data-value-id="{% if attr.id %}{{ attr.id }}{% else %}{{ attr.value }}{% endif %}"
                                                                   data-value-displ-name="{{ attr.name }}" data-category="{{ attr.category }}">
                                                            {{ attr.name }} <!-- <span class="count">({{ attr.count }})</span> -->
                                                        </label>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </li>
                    </ul>
                </div>
                <!-- user data filters tab -->
                <div role="tabpanel" class="tab-pane" id="user-data-filters">
                    <ul class="list-group" id="data-type-accordion" role="tablist" aria-multiselectable="true">
                        <li class="list-group-item">
                            <div id="user-data-filter-alert" class="alert alert-warning alert-dismissable">
                                <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                Filtering on User Projects and Studies is exclusive to the other filters, and will produce a cohort consisting <i>only</i> of samples from User Data uploads. The Set
                                operations on the Cohort Editing page can be used to further refine cohorts composed of User Data.
                            </div>
                        </li>
                        {% for attr in user_data %}
                            <li class="list-group-item">
                                <div class="list-group-item__heading" role="tab" id="heading-{{ attr.id }}">
                                    <a role="button" data-toggle="collapse" data-parent="#data-type-accordion" href="#collapse-{{ attr.id }}"
                                       aria-expanded="false" aria-controls="collapse-{{ attr.id }}">
                                        <i class="fa fa-caret-right"></i><i class="fa fa-caret-down" style="display:none;"></i> {% if attr.displ_name %}{{ attr.displ_name }}{% elif attr.name %}{{ attr.name }}{% else %}{{ attr.id }}{% endif %}
                                    </a>
                                </div>
                                <div id="collapse-{{ attr.id }}" class="list-group-item__body collapse cohort-feature-select-block" role="tabpanel"
                                     aria-labelledby="heading-{{ attr.id }}" data-feature-name="{{ attr.name }}" data-feature-id="{{ attr.id }}"
                                     data-feature-displ-name="{% if attr.displ_name %}{{ attr.displ_name }}{% elif attr.name %}{{ attr.name }}{% else %}{{ attr.id }}{% endif %}"
                                     data-feature-type="user-data">
                                    <ul class="search-checkbox-list" id="{{ attr.id }}">
                                        {% for v in attr.values %}
                                            <li class="checkbox">
                                                <label>
                                                    <input type="checkbox" name="elements-selected" data-value-name="{{ v.name }}"
                                                           data-value-id="{% if v.id %}{{ v.id }}{% elif v.name %}{{ v.name }}{% else %}{{ v.value }}{% endif %}"
                                                           data-value-displ-name="{% if v.display_name %}{{ v.displ_name }}{% elif v.name %}{{ v.name }}{% else %}{{ v.id }}{% endif %}">
                                                    {% if v.display_name %}{{ v.displ_name }}{% elif v.name %}{{ v.name }}{% else %}{{ v.id }}{% endif %} <span class="count">({{ v.count }})</span>
                                                </label>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="selected-filters panel panel-default">
            <div class="panel-heading clearfix">
                <h4 class="panel-title pull-left">Selected Filters</h4>
                <a class="pull-right" role="button" id="clear-filters">Clear All</a>
            </div>
            <div class="panel-body">

            </div>
        </div>

        <div class="cohort-info panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">Details</h4>
            </div>
            <div class="panel-body">
                <div class="row col-md-6">
                    <span class="detail-label">Total Number of Samples:</span>
                    <div class="spinner" style="display:none;"><i class="fa fa-spinner fa-spin"></i></div>
                    <span class="total-values" id="total-samples">TBD</span>
                </div>
                <div class="row col-md-6">
                    <span class="detail-label">Total Number of Participants:</span>
                    <div class="spinner" style="display:none;"><i class="fa fa-spinner fa-spin"></i></div>
                    <span class="total-values" id="total-participants">TBD</span>
                </div>
            </div>
        </div>

        <div class="clinical-trees panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">Clinical Features</h4>
            </div>
            <div class="panel-body">
                <div class="spinner" style="display:none;"><i class="fa fa-spinner fa-spin"></i></div>
                <div id="tree-graph-clinical"></div>
            </div>
            <div id="more-graphs"><button class="btn btn-link" role="button">Show More</button></div>
            <div id="less-graphs" style="display: none;"><button class="btn btn-link" role="button">Show Less</button></div>
        </div>

        <div class="parallel-sets panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">Public Data Availability</h4>
            </div>
            <div class="panel-body">
                <div class="spinner" style="display:none;"><i class="fa fa-spinner fa-spin"></i></div>
                <div id="multi-categorical"></div>
            </div>
        </div>
    </div>

    <!-- Create Cohort Modal -->
    <div class="modal fade" id="create-cohort-modal" tabindex="-1" role="dialog" aria-labelledby="createCohortModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="createCohortModal">Create Cohort</h4>
                </div>
                {% if workbook and worksheet %}
                    <form id="create-cohort-form" method="POST" action="{% url 'save_cohort_for_existing_workbook' %}" >
                    <input type="hidden" value="{{ worksheet.id }}" name="worksheet_id" />
                    <input type="hidden" value="{{ workbook.id }}" name="workbook_id" />
                {% elif create_workbook %}
                    <form id="create-cohort-form" method="POST" action="{% url 'save_cohort_for_new_workbook' %}" >
                {% else %}
                    <form id="create-cohort-form" method="POST" action="{% url 'save_cohort' %}">
                {% endif %}
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="cohort-name">Name:</label>
                            <input class="form-control" type="text" id="cohort-name" name="name" required />
                        </div>
                        <div class="form-group">
                            <h5>Selected Filters:</h5>
                            <p class="form-control-static"></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        {% csrf_token %}
                        <input type="submit" value="Create Cohort" class="btn btn-primary" />
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
    var attr_list = {{ attr_list|tojson|safe }};
    var total_samples = {{ total_samples|safe }};
    var attr_counts = {{ attr_list_count|tojson|safe }};
    var base_url = '{{ base_url|safe }}';
    var base_api_url = '{{ base_api_url|safe }}';
    var cohort_id = undefined;
    var user_data = {{ user_data|tojson|safe }};
    var metadata_counts = {{ metadata_counts|tojson|safe }};
    var metadata_filters = {{ metadata_filters|tojson|safe }};
    </script>
{% endblock %}

{% block js_file %}{% static 'js/cohort_details.js' %}{% endblock %}
