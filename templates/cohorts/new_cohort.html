{% extends 'base.html' %}
{% load staticfiles %}
{% load custom_tags %}

{% comment %}

   Copyright 2016, Institute for Systems Biology

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

{% endcomment %}

{% block header %}
{% endblock %}
{% block link_page_name %}cohort-details{% endblock %}
{% block page_name %}cohort-details{% endblock %}

{% block page_header %}
<link type="text/css" rel="stylesheet" href="{% static 'css/token-typeahead.css' %}" />

<div class="container">
    {% if workbook %}
        <ol class="breadcrumb">
            <li><a href="{% url 'dashboard' %}">Your Dashboard</a></li>
            <li><a href="{% url 'workbooks' %}">Saved Workbooks</a></li>
            <li><a href="{% url 'worksheet_display' workbook.id worksheet.id%}">{{ workbook.name }}</a></li>
        </ol>
    {% else %}
        <ol class="breadcrumb">
            <li><a href="{% url 'dashboard' %}">Your Dashboard</a></li>
            <li><a href="{% url 'cohort_list' %}">Cohorts</a></li>
        </ol>
    {% endif %}
    <h1 class="page-header pull-left">Create Cohort</h1>
    {% if workbook %}
        <button class="btn btn-primary pull-right" data-toggle="modal" data-target="#create-cohort-modal">Apply to Worksheet</button>
    {% elif create_workbook %}
        <button class="btn btn-primary pull-right" data-toggle="modal" data-target="#create-cohort-modal">Apply to new Worksheet</button>
    {% else %}
        <button class="btn btn-primary pull-right" data-toggle="modal" data-target="#create-cohort-modal">Save As New Cohort</button>
    {% endif %}
</div>

{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div id="url-len-max-alert" class="alert alert-warning alert-dismissable" style="display: none;">
                    <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    You have selected too many filters. The current counts shown will not be accurate until one or more filter options are removed.
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <div class="panel panel-default">
                <ul class="nav nav-tabs nav-tabs-data" role="tablist">
                    <li role="presentation" class="active"><a href="#isb-cgc-data" role="tab" data-toggle="tab" title="Donor Filters">ISB-CGC Data</a></li>
                    <li role="presentation" class=""><a href="#user-data" role="tab" data-toggle="tab" title="User Data">User Data</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="tab-content data-tab-content">
            {% include "cohorts/isb-cgc-data.html" %}
            {% include "cohorts/user-data.html" %}
        </div>
    </div>

    <!-- Create Cohort Modal -->
    <div class="modal fade" id="create-cohort-modal" tabindex="-1" role="dialog" aria-labelledby="createCohortModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="createCohortModal">Create Cohort</h4>
                </div>
                <div id="one-cohort-type-per-create-warn" class="alert alert-warning alert-dismissable" style="display: none;">
                    <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    A cohort can only be made with ISB-CGC Data <b>or</b> User Data filters, not with both. Because the <span class="one-per-warn"></span> tab was active,
                    we have chosen those filters. If you wish to create your cohort with the other filter set, cancel this dialog (using the X in the upper-right corner) and
                    switch to that tab before clicking the <b>Save as New Cohort</b> button.
                </div>
                {% if workbook and worksheet %}
                    <form id="create-cohort-form" method="POST" action="{% url 'save_cohort_for_existing_workbook' %}" >
                    <input type="hidden" value="{{ worksheet.id }}" name="worksheet_id" />
                    <input type="hidden" value="{{ workbook.id }}" name="workbook_id" />
                {% elif create_workbook %}
                    <form id="create-cohort-form" method="POST" action="{% url 'save_cohort_for_new_workbook' %}" >
                {% else %}
                    <form id="create-cohort-form" method="POST" action="{% url 'save_cohort' %}">
                {% endif %}
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="cohort-name">Name:</label>
                            <input class="form-control" type="text" id="cohort-name" name="name" required />
                        </div>
                        <div class="form-group">
                            <h5>Selected Filters:</h5>
                            <p class="form-control-static"></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        {% csrf_token %}
                        <input type="submit" value="Create Cohort" class="btn btn-primary" />
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
    var attr_list = {{ attr_list|tojson|safe }};
    var total_samples = {{ total_samples|safe }};
    var attr_counts = {{ attr_list_count|tojson|safe }};
    var base_url = '{{ base_url|safe }}';
    var base_api_url = '{{ base_api_url|safe }}';
    var cohort_id = undefined;
    var user_data = {{ user_data|tojson|safe }};
    var metadata_counts = {{ metadata_counts|tojson|safe }};
    var metadata_filters = {{ metadata_filters|tojson|safe }};
    </script>
{% endblock %}

{% block js_file %}{% static 'js/cohort_details.js' %}{% endblock %}
