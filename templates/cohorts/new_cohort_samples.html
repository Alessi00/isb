{% extends 'base.html' %}
{% load staticfiles %}
{% load custom_tags %}

{% comment %}

   Copyright 2016, Institute for Systems Biology

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

{% endcomment %}

{% block header %}
{% endblock %}
{% block link_page_name %}cohort-details{% endblock %}
{% block page_name %}cohort-details{% endblock %}

{% block page_header %}
<link type="text/css" rel="stylesheet" href="{% static 'css/token-typeahead.css' %}" />

<div class="container">
    {% if workbook %}
        <ol class="breadcrumb">
            <li><a href="{% url 'dashboard' %}">Your Dashboard</a></li>
            <li><a href="{% url 'workbooks' %}">Saved Workbooks</a></li>
            <li><a href="{% url 'worksheet_display' workbook.id worksheet.id%}">{{ workbook.name }}</a></li>
        </ol>
    {% else %}
        <ol class="breadcrumb">
            <li><a href="{% url 'dashboard' %}">Your Dashboard</a></li>
            <li><a href="{% url 'cohort_list' %}">Cohorts</a></li>
        </ol>
    {% endif %}
    <h1 class="page-header pull-left">Create Cohort - Barcodes</h1>
    {% if workbook %}
        <button class="btn btn-primary pull-right" data-toggle="modal" data-target="#create-cohort-modal">Apply to Worksheet</button>
    {% elif create_workbook %}
        <button class="btn btn-primary pull-right" data-toggle="modal" data-target="#create-cohort-modal">Apply to new Worksheet</button>
    {% else %}
        <button class="btn btn-primary pull-right" data-toggle="modal" data-target="#create-cohort-modal">Save As New Cohort</button>
    {% endif %}
</div>

{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div id="url-len-max-alert" class="alert alert-warning alert-dismissable" style="display: none;">
                    <button type="button" class="close" data-hide="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    You have selected too many filters. The current counts shown will not be accurate until one or more filter options are removed.
                </div>
            </div>
        </div>
    </div>

    <div class="row cgc-user-data-type-tabs">
        <div class="col-sm-12 col-md-12 col-lg-12">
            <div class="panel panel-default">
                <ul class="nav nav-tabs nav-tabs-data" role="tablist">
                    <li role="presentation" class="active"><a href="#upload-file" role="tab" data-toggle="tab" title="Upload a list of barcodes">Upload</a></li>
                    <li role="presentation"><a href="#enter-barcodes" role="tab" data-toggle="tab" title="Enter a list of barcodes">Enter</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="tab-content data-tab-content">
            <div id="upload-file" class="tab-pane active data-tab" role="tabpanel">
                <div class="col-md-12 data-tab-content-panel spinner-panel">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4>Upload a file of sample or case barcodes</h4>
                        </div>
                        <div class="panel-body">
                            <div id="uploadField" class="center" style="display : inline-block;">
                                <button class="btn btn-link nocap" id="file-upload-btn">
                                    <i class="fa fa-file"></i> Upload sample/case barcode list
                                </button>
                                <input type="file" name="upload" id="file-upload-field" style="display: none">
                                <div id="uploading" class="collapse" style="margin-left: 20px;">
                                    <i class="fa fa-circle-o-notch fa-spin"></i>  <span id="selected-file-name"></span>
                                </div>
                            </div>
                            <button class="btn btn-primary instructions" title="Show/Hide the upload instructions">Instructions</button>
                            <div class="instructions" style="display: none;">
                                <p>All files must be in tab- or comma-delimited format (TSV or CSV), and should not include any headers. Quotes around values are optional. Format your entries as follows:</p>
                                <ul><pre>Sample Barcode (optional), Case Barcode (required), Program Short Name (required)</pre></ul>
                                <p><b>Note:</b> If a sample barcode is omitted, all samples associate with a provided case barcode will be included.</p>
                                <p>Example Entries:</p>
                                <ul>
                                    <pre>,TCGA-N9-A4Q4,TCGA
TCGA-N7-A4Y8-01A,TCGA-N7-A4Y8,TCGA
'CCLE-Saos-2','Saos-2', 'CCLE'
'','Hs 863.T','CCLE'
"TARGET-51-PAJLIV-10A", "TARGET-51-PAJLIV", "TARGET"
"", "TARGET-51-PAJMFS", "TARGET"</pre>
                                </ul>
                                <p>Valid program short names:</p>
                                <ul>
                                    <li>TCGA</li>
                                    <li>CCLE</li>
                                    <li>TARGET</li>
                                </ul>
                                <p>After selecting the file and uploading it, the entries will be verified. Any entries which are found to be invalid will be listed, and you can choose to omit them or select a new file for verificaiton and upload.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="enter-barcodes" class="tab-pane data-tab" role="tabpanel">
                <div class="col-md-12 data-tab-content-panel spinner-panel">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4>Paste a set of sample or case barcodes</h4>
                        </div>
                        <div class="panel-body">
                            <h5>Sample/Case Barcode Entries</h5>
                            <textarea></textarea>
                            <p>
                                <button class="btn btn-primary verify" title="Verify the barcode set">Verify</button>
                                <button class="btn btn-primary save" title="Create the cohort" disabled>Save Cohort</button>
                            </p>
                            <button class="btn btn-primary instructions" title="Show/Hide the upload instructions">Instructions</button>
                            <div class="instructions" style="display: none;">
                                <p>All entries must be in tab- or comma-separated format, and should not include any headers. Quotes around values are optional. Format your entries as follows:</p>
                                <ul><pre>Sample Barcode (optional), Case Barcode (required), Program Short Name (required)</pre></ul>
                                <p><b>Note:</b> If a sample barcode is omitted, all samples associate with a provided case barcode will be included.</p>
                                <p>Example Entries:</p>
                                <ul>
                                    <pre>,TCGA-N9-A4Q4,TCGA
TCGA-N7-A4Y8-01A,TCGA-N7-A4Y8,TCGA
'CCLE-Saos-2','Saos-2', 'CCLE'
'','Hs 863.T','CCLE'
"TARGET-51-PAJLIV-10A", "TARGET-51-PAJLIV", "TARGET"
"", "TARGET-51-PAJMFS", "TARGET"</pre>
                                </ul>
                                <p>Valid program short names:</p>
                                <ul>
                                    <li>TCGA</li>
                                    <li>CCLE</li>
                                    <li>TARGET</li>
                                </ul>
                                <p>Click the 'Verify' button to check your entries. Any entries which are found to be invalid will be listed, and you can choose to omit them or re-enter the set.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Cohort Modal -->
    <div class="modal fade" id="create-cohort-modal" tabindex="-1" role="dialog" aria-labelledby="createCohortModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="createCohortModal">Create Cohort</h4>
                </div>
                {% if workbook and worksheet %}
                    <form id="create-cohort-form" method="POST" action="{% url 'save_cohort_for_existing_workbook' %}" >
                    <input type="hidden" value="{{ worksheet.id }}" name="worksheet_id" />
                    <input type="hidden" value="{{ workbook.id }}" name="workbook_id" />
                {% elif create_workbook %}
                    <form id="create-cohort-form" method="POST" action="{% url 'save_cohort_for_new_workbook' %}" >
                {% else %}
                    <form id="create-cohort-form" method="POST" action="{% url 'save_cohort' %}">
                {% endif %}
                    <div class="modal-body">
                        <div id="multi-prog-cohort-create-warn" class="alert alert-warning alert-dismissable" style="display: none;">
                            <button type="button" class="close" data-hide="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                            Your cohort contains samples from multiple programs. Please note that filters will only apply to samples from the program indicated
                            by the tab they were chosen on - they will not apply to samples from other programs in this cohort.
                        </div>
                        <div id="unallowed-chars-alert" class="alert alert-warning alert-dismissable" style="display: none;">
                            <button type="button" class="close" data-hide="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                            Your cohort's name contains invalid characters (<span class="unallowed-chars"></span>). Please choose another name.
                        </div>
                        <div id="at-least-one-filter-alert-modal" class="alert alert-warning alert-dismissable" style="display: none;">
                            <button type="button" class="close" data-hide="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                            You must choose at least one filter to include samples in your cohort.
                        </div>
                        <div class="form-group">
                            <label for="cohort-name">Name:</label>
                            <input class="form-control" type="text" id="create-cohort-name" name="name" required />
                        </div>
                        <div class="form-group">
                            <h5>Selected Filters:</h5>
                            <p id="selected-filters" class="form-control-static"></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        {% csrf_token %}
                        <input type="submit" value="Create Cohort" class="btn btn-primary" />
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
    var cohort_id = undefined;
    </script>
{% endblock %}

{% block js_file %}{% static 'js/cohort_samples_details.js' %}{% endblock %}
