{% extends 'base.html' %}
{% load staticfiles %}
{% load custom_tags %}

{% comment %}

   Copyright 2017, Institute for Systems Biology

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

{% endcomment %}

{% block header %}
{% endblock %}

{% block page_name %}cohort-filelist{% endblock %}

{% block page_header %}
    <div class="container">
        <ol class="breadcrumb">
            <li><a href="{% url 'dashboard' %}">Your Dashboard</a></li>
            <li><a href="{% url 'cohort_list' %}">Saved Cohorts</a></li>
            <li><a href="{% url 'cohort_details' cohort.id %}">{{ cohort.name }}</a></li>
        </ol>
        <h3 class="page-header">File Browser: <a href="{% url 'cohort_details' cohort.id %}">{{ cohort.name }}</a></h3>
        <div id="file-list-warning" class="alert alert-warning alert-dismissable" style="display: none;">
            <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            The maximum number of files which can be downloaded in a list is <span class="file-list-limit">#</span>. Your selections currently total
            <span class="file-list-total">#</span>. Please filter your list using the platform panel at the left (or make a smaller cohort) to limit the size of your file download list.
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-sm-12 col-md-12 col-lg-12">
            <div class="panel panel-default">
                <ul class="nav nav-tabs nav-tabs-files" role="tablist">
                    <li role="presentation" class="file-browser-tab active"><a href="#all-files" role="tab" data-toggle="tab" title="Browse All Files" data-file-type="all">All Files</a></li>
                    <li role="presentation" class="file-browser-tab"><a href="#igv-files" role="tab" data-toggle="tab" title="Browse IGV Files" data-file-type="igv">IGV</a></li>
                    <li role="presentation" class="file-browser-tab"><a href="#camic-files" role="tab" data-toggle="tab" title="Browse caMicroscope Files" data-file-type="camic">caMicroscope</a></li>
                    <li role="presentation" class="file-browser-tab"><a href="#dicom-files" role="tab" data-toggle="tab" title="Browse Radiology Files" data-file-type="dicom">DICOM</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="tab-content data-tab-content">
            <div id="placeholder" class="tab-pane active file-browser-tab" role="tabpanel">
                <div class="col-md-12 data-tab-content-panel spinner-panel">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <div class="spinner"><i class="fa fa-spinner fa-spin"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if cohort.perm.perm == 'OWNER' %}
    <!-- Export File Manifest Modal -->
    <div class="modal fade" id="export-manifest-modal" tabindex="-1" role="dialog" aria-labelledby="export-manifest-header" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 id="export-manifest-header" class="modal-title">File Manifest Export</h4>
                    <div class="modal-js-messages" id="export-manifest-js-messages">
                    </div>
                </div>
                <form id="export-manifest-form" method="POST" action="{% url 'export_cohort_filelist_to_bq' cohort.id %}">
                    {% csrf_token %}
                    <input type="hidden" class="param" name="build" value="{{ build }}" />
                    <div class="modal-body">
                        <div class="message-container"></div>
                        <div class="form-group">
                            <label for="export-manifest-project-dataset">Choose a Project and Dataset:</label>
                            <select id="export-manifest-project-dataset" name="project-dataset" class="form-control">
                                <option value="" disabled selected type="label">Please select a project and dataset</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <ul class="table-type" disabled>
                                <div class="radio table-type">
                                    <label class="table-type" title="Select a project and dataset to enable this option."><input class="table-type" type="radio" name="table-type" value="new" disabled checked> Make a new table</label>
                                </div>
                                <div class="radio table-type">
                                    <label class="table-type" title="Select a project and dataset to enable this option."><input class="table-type" type="radio" name="table-type" value="append" disabled> Append to an existing table</label>
                                </div>
                            </ul>
                        </div>
                        <div class="form-group table-list" style="display: none;">
                            <label for="table-name">Choose a table:</label>
                            <select id="export-manifest-table" name="table-name" class="form-control">
                                <option value="" disabled selected type="label">Please select a table</option>
                            </select>
                        </div>
                        <div class="form-group new-table-name">
                            <label for="new-table-name">Name:</label>
                            <input title="Select a project and dataset to enable this option." disabled class="form-control new-table-name" type="text" maxlength="1024" placeholder="If left blank, a table name will be provided." id="new-table-name" name="new-table-name" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        {% csrf_token %}
                        <input type="submit" value="Export File Manifest" class="btn btn-primary" />
                        <button type="button" class="btn btn-link" data-dismiss="modal">Cancel</button>
                        <div id="exporting-cohort" class="collapse" style="display: none;">
                            <i class="fa fa-circle-o-notch fa-spin"></i>  Exporting File Manifest...
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <script type="text/javascript">
    console.debug('{{ cohort.perm.perm }}');
    var cohort_id = {{ cohort.id }};
    var page = 1;
    var download_url = '{{ download_url }}';
    var ajax_update_url = {
        'all': '{% url 'cohort_filelist_ajax_panel' cohort.id 'all' %}',
        'igv': '{% url 'cohort_filelist_ajax_panel' cohort.id 'igv' %}',
        'camic':'{% url 'cohort_filelist_ajax_panel' cohort.id 'camic' %}',
        'dicom':'{% url 'cohort_filelist_ajax_panel' cohort.id 'dicom' %}'
    };
    var DICOM_URL = {% url 'dicom' %};
    var SEL_IGV_FILE_MAX = '{{  sel_file_max }}';
    var FILE_LIST_MAX = '{{  file_list_max }}';
    var IMG_THUMBS_URL = '{{ img_thumbs_url }}'
    </script>
{% endblock %}

{% block js_file %}{% static 'js/cohort_filelist.js' %}{% endblock %}
